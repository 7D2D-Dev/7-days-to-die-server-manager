<body>
  <%- exposeLocalsToBrowser() %>

    <form id="addServer">
      <div class="form-group">
        <label for="servername">Name</label>
        <input type="text" class="form-control" id="servername" aria-describedby="server-name-help" placeholder="World's best server!!">
        <small id="server-name-help" class="form-text text-muted">Give your server a memorable name</small>
      </div>
      <div class="form-group">
        <label for="serverip">Server IP</label>
        <input type="text" class="form-control" id="serverip" placeholder="Server IP address">
        <small>Provide a valid IPv4/6 adress or a <a href="https://en.wikipedia.org/wiki/Fully_qualified_domain_name">FQDN</a></small>
      </div>
      <div class="form-group">
        <label for="webport">Web API port</label>
        <input type="number" class="form-control" id="webport" aria-describedby="webportHelp" placeholder="ex. 8084">
        <small id="webportHelp" class="form-text text-muted">Port added by Allocs fixes</small>
      </div>
      <div class="form-group">
        <label for="telnetport">Telnet port</label>
        <input type="number" class="form-control" id="telnetport" placeholder="ex. 8081">
      </div>
      <div class="form-group">
        <label for="telnetpassword">Telnet password</label>
        <input type="password" class="form-control" id="telnetpassword" aria-describedby="passwordHelp" placeholder="Password">
        <small id="passwordHelp" class="form-text text-muted">We only use your password for setup. It is never stored anywhere!</small>
      </div>
      <button type="submit" class="btn btn-primary">Submit</button>
    </form>

    <div id="message" class="float-right w-25 p-3"></div>

</body>

<script>
  $("#addServer").submit(function (event) {
    event.preventDefault();
    const serverip = $("#serverip").val(),
      webport = $("#webport").val(),
      telnetport = $("#telnetport").val(),
      telnetpassword = $("#telnetpassword").val(),
      servername = $("#servername").val()

      $('#servername').removeClass("is-invalid");
      $('#serverip').removeClass("is-invalid");
      $('#webport').removeClass("is-invalid");
      $('#telnetport').removeClass("is-invalid");
      $('#telnetpassword').removeClass("is-invalid");

    if (servername === '') {
      return $('#servername').addClass("is-invalid")
    }

    if (serverip === '' || !(validator.isIP(serverip) || validator.isFQDN(serverip))) {
      return $('#serverip').addClass("is-invalid")
    }

    if (webport === '' || !validator.isPort(webport)) {
      return $('#webport').addClass("is-invalid")
    }
    if (telnetport === '' || !validator.isPort(telnetport)) {
      return $('#telnetport').addClass("is-invalid")
    }
    if (telnetpassword === '') {
      return $('#telnetpassword').addClass("is-invalid")
    }



    $.ajax({
      url: "/api/sdtdserver/addserver",
      type: 'POST',
      data: {
        _csrf: window.SAILS_LOCALS._csrf,
        serverName: servername,
        serverIp: serverip,
        webPort: webport,
        telnetPort: telnetport,
        telnetPassword: telnetpassword
      },
      success: (data, status, xhr) => {
        let errorMessage = new String();
        if (data.error) {
          switch (data.error) {
            case 'badTelnet':
              errorMessage = `Could not connect to telnet! Confirm the values you entered for telnet connection are correct!`
              break;
            case 'badWebPort':
              errorMessage = `Could not connect to your server! Confirm the web port is correct!`
              break;
            default:
              break;
          }
          return $('#message').text(errorMessage)
        } else {
          window.location.replace(`/sdtdserver/${data.id}/dashboard`)
        }
      },
      error: (xhr, status, error) => {
        let htmlToAdd =
          `<h2>Error</h2> <br> <p>${xhr.responseText}</p> <br> <p>Contact support for more help please</p>`
        $("#message").append(htmlToAdd)
      }
    })


  })

</script>