<body>
  <%- exposeLocalsToBrowser() %>

  <div class="row">
    <div class="col-12">
      <h1>Add a server</h1>
      <p>Check the documentation if you don't know what to fill in. If you are lost or keep getting errors, swing by the discord server for some help! :)</p>
    </div>
  </div>

  <div class="row">
    <div class="col-8">
      <form id="addServer">
        <div class="form-group">
          <label for="servername">Name</label>
          <input type="text" class="form-control" id="servername" aria-describedby="server-name-help" placeholder="World's best server!!">
          <small id="server-name-help" class="form-text text-muted">Give your server a memorable name</small>
        </div>
        <div class="form-group">
          <label for="serverip">Server IP</label>
          <input type="text" class="form-control" id="serverip" placeholder="Server IP address">
          <small>Provide a valid IPv4/6 adress or a
            <a href="https://en.wikipedia.org/wiki/Fully_qualified_domain_name">FQDN</a>
          </small>
        </div>
        <div class="form-group">
          <label for="webport">Web API port</label>
          <input type="number" class="form-control" id="webport" aria-describedby="webportHelp" placeholder="ex. 8084">
          <small id="webportHelp" class="form-text text-muted">Port added by Allocs fixes</small>
        </div>
        <div class="form-group">
          <label for="authName">Authorization name</label>
          <input type="text" class="form-control" id="authName" placeholder="ex. csmm">
          <small class="form-text text-muted">Set this with telnet command</small>
        </div>
        <div class="form-group">
          <label for="authToken">Authorization token</label>
          <input type="text" class="form-control" id="authToken" placeholder="ex. super-secret-token">
          <small class="form-text text-muted">Set this with telnet command</small>
        </div>
        <button type="submit" class="btn btn-primary">Submit</button>
      </form>
    </div>
    <div class="col-4">
      <div id="errorMessage"></div>
    </div>
  </div>

    

    

</body>

<script>
  $("#addServer").submit(function (event) {
    event.preventDefault();
    const serverip = $("#serverip").val(),
      webport = $("#webport").val(),
      authName = $("#authName").val(),
      authToken = $("#authToken").val(),
      servername = $("#servername").val()

    $('#servername').removeClass("is-invalid");
    $('#serverip').removeClass("is-invalid");
    $('#webport').removeClass("is-invalid");
    $('#authName').removeClass("is-invalid");
    $('#authToken').removeClass("is-invalid");

    if (servername === '') {
      return $('#servername').addClass("is-invalid")
    }

    if (serverip === '' || !(validator.isIP(serverip) || validator.isFQDN(serverip))) {
      return $('#serverip').addClass("is-invalid")
    }

    if (webport === '' || !validator.isPort(webport)) {
      return $('#webport').addClass("is-invalid")
    }
    if (authName === '') {
      return $('#authName').addClass("is-invalid")
    }
    if (authToken === '') {
      return $('#authToken').addClass("is-invalid")
    }



    $.ajax({
      url: "/api/sdtdserver/addserver",
      type: 'POST',
      data: {
        _csrf: window.SAILS_LOCALS._csrf,
        serverName: servername,
        serverIp: serverip,
        webPort: webport,
        authName: authName,
        authToken: authToken
      },
      success: (data, status, xhr) => {
        window.location.replace(`/sdtdserver/${data.id}/dashboard`)
      },
      error: (xhr, status, error) => {
        if (xhr.responseJSON == "cantConnect") {
          $('#errorMessage').text(`Could not connect to the server! Check the documentation for help with setup`)
        }
        if (xhr.responseJSON == "serverExists") {
          $('#errorMessage').text(`A server with that IP and webport is already in the system.`)
        }

        $('#errorMessage').prepend("Error: <br>")
      }
    })


  })

</script>