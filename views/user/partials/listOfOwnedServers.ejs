<%- exposeLocalsToBrowser() %>

  <div id="list-of-owned-servers" aria-multiselectable="true">


    <table class="table table-hover table-responsive">

      <tbody>

        <% ownedServers.forEach(server => { %>

          <tr>

            <td>
              <%= server.name %>
            </td>
            <% let playersId = `server-${server.id}-players` %>
              <td id="<%=playersId %>"> Loading
              </td>
              <% let fpsId = `server-${server.id}-fps` %>
                <td id="<%= fpsId %>">Loading</td>
                <td>
                  <% const dashboardLink = '/sdtdserver/' + server.id + '/dashboard' %>
                    <a href='<%= dashboardLink %>' class="btn btn-sm btn-primary">
                      <em class="glyphicon glyphicon-align-justify"></em>
                      Dashboard
                    </a>
                </td>
                <td>
                  <% const settingsLink = '/sdtdserver/' + server.id + '/settings' %>
                    <a href='<%= settingsLink %>' class="btn btn-sm btn-primary">
                      <em class="glyphicon glyphicon-align-justify"></em>
                      <i class="fa fa-cog" aria-hidden="true"></i> Settings
                    </a>
                </td>
                <td>
                  <% const ticketsLink = '/sdtdserver/' + server.id + '/tickets' %>
                    <a href='<%= ticketsLink %>' class="btn btn-sm btn-primary">
                      <em class="glyphicon glyphicon-align-justify"></em>
                      <i class="fa fa-ticket" aria-hidden="true"></i> Tickets
                      <span id="sdtd-server-<%= server.id %>-tickets-badge" class="badge badge-secondary">
                        <i class="fa fa-cog" aria-hidden="true"></i>
                      </span>
                    </a>
                </td>
                <td>
                    <% const playersLink = '/sdtdserver/' + server.id + '/players' %>
                  <a name="" id="" class="btn btn-primary btn-sm" href="<%= playersLink %>" role="button">Players</a>
                </td>
                <td>
                    <% const analytics = '/sdtdserver/' + server.id + '/analytics' %>
                  <a name="" id="" class="btn btn-primary btn-sm" href="<%= analytics %>" role="button">Analytics</a>
                </td>
          </tr>
          <% }) %>


      </tbody>
    </table>



  </div>

  <script>
    $(document).ready(function () {

      let listOfServers = window.SAILS_LOCALS.ownedServers


      setInterval(function () {
        listOfServers.forEach(server => {
          sendRequestAndUpdateFps(server)
        })
      }, 300000)

      listOfServers.forEach(server => {
        $.ajax({
          url: `/api/sdtdticket/opentickets`,
          data: {
            serverId: server.id
            },
          success: (data, status, xhr) => {
            let opentickets = data;
            $(`#sdtd-server-${server.id}-tickets-badge`).text(opentickets.length)

          },
          error: (xhr, status, error) => {
            console.log(error)
          }
        });

        sendRequestAndUpdateFps(server)
        io.socket.get('/sdtdserver/' + server.id + '/socket', function (response) {
          sendRequestAndUpdatePlayers(server);
        });

        io.socket.on('playerConnected', (connectedMessage) => {
          sendRequestAndUpdatePlayers(server);
        })

        io.socket.on('playerDisconnected', (disconnectedMessage) => {
          sendRequestAndUpdatePlayers(server);
        })

      })
    })

    function sendRequestAndUpdateFps(server) {

      let serverId = server.id;
      $.get('/api/sdtdserver/fps', { serverId: serverId }, response => {
        $(`#server-${server.id}-fps`).text(`${response} FPS`)
      })

    }


    function sendRequestAndUpdatePlayers(server) {
      $.ajax({
        url: '/api/sdtdserver/players',
        data: {
          serverId: server.id
        },
        success: (data, status, xhr) => {
          let onlinePlayers = data.players.filter(player => {
            return player.online
          })
          $(`#server-${server.id}-players`).text(`${onlinePlayers.length} online`)
        },
        error: (xhr, status, error) => {
          console.log(`Could not update online players! error: ${error}`)
        }
      })
    }


  </script>