<%- exposeLocalsToBrowser() %>

  <div id="list-of-owned-servers" aria-multiselectable="true">

    <% if (ownedServers.length === 0) { %>
      <p>No servers added yet!</p>
      <% } %>

    <table class="table table-hover table-responsive">

      <tbody>


        <% ownedServers.forEach(server => { %>

          <tr>

            <td>
              <%= server.name %>
            </td>
            <% let playersId = `server-${server.id}-players` %>
              <td id="<%=playersId %>"> Loading
              </td>
              <% let fpsId = `server-${server.id}-fps` %>
                <td id="<%= fpsId %>">Loading</td>
                <td>
                  <% const dashboardLink = '/sdtdserver/' + server.id + '/dashboard' %>
                    <a href='<%= dashboardLink %>' class="btn btn-sm btn-primary">
                      <em class="glyphicon glyphicon-align-justify"></em>
                      <i class="fas fa-tachometer-alt"></i> Dashboard
                    </a>
                </td>
                <td>
                  <% const settingsLink = '/sdtdserver/' + server.id + '/settings' %>
                    <a href='<%= settingsLink %>' class="btn btn-sm btn-primary">
                      <em class="glyphicon glyphicon-align-justify"></em>
                      <i class="fa fa-cog" aria-hidden="true"></i> Settings
                    </a>
                </td>
                <td>
                  <% const ticketsLink = '/sdtdserver/' + server.id + '/tickets' %>
                    <a href='<%= ticketsLink %>' class="btn btn-sm btn-primary">
                      <em class="glyphicon glyphicon-align-justify"></em>
                      <i class="fas fa-question"></i> Tickets
                      <span id="sdtd-server-<%= server.id %>-tickets-badge" class="badge badge-secondary">
                      </span>
                    </a>
                </td>
                <td>
                  <% const playersLink = '/sdtdserver/' + server.id + '/players' %>
                    <a name="" id="" class="btn btn-primary btn-sm" href="<%= playersLink %>" role="button">
                      <i class="far fa-address-card"></i> Players</a>
                </td>
                <td>
                  <% const analytics = '/sdtdserver/' + server.id + '/analytics' %>
                    <a name="" id="" class="btn btn-primary btn-sm" href="<%= analytics %>" role="button">
                      <i class="far fa-chart-bar"></i> Analytics</a>
                </td>
                <td>
                  <% const economy = '/sdtdserver/' + server.id + '/economy' %>
                    <a name="" id="" class="btn btn-primary btn-sm" href="<%= economy %>" role="button">
                      <i class="far fa-money-bill-alt"></i> Economy (beta)</a>
                </td>

                <td>

                  <!-- Button trigger modal -->
                  <button type="button" class="btn btn-sm btn-danger" data-toggle="modal" data-target="#delete-server-<%= server.id %>-button">
                    <i class="fas fa-trash-alt"></i> Delete
                  </button>
                  <!-- Modal -->
                  <div class="modal fade" id="delete-server-<%= server.id %>-button" tabindex="-1" role="dialog" aria-labelledby="delete-server-<%= server.id %>-modal"
                    aria-hidden="true">
                    <div class="modal-dialog" role="document">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h4 class="modal-title" id="delete-server-<%= server.id %>-modal">Delete server</h4>
                          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                          </button>
                        </div>
                        <div class="modal-body">
                          <div class="container-fluid">
                            Are you sure?
                          </div>
                        </div>
                        <div class="modal-footer">
                          <% const deleteLink = '/sdtdserver/' + server.id + '/delete' %>
                            <a href='<%= deleteLink %>'>
                              <button id="delete-server-<%= server.id %>-button" class="btn btn-default btn-danger" type="button">
                                <em class="glyphicon glyphicon-align-justify"></em>
                                Delete server
                              </button>
                            </a>

                            <button type="button" class="btn btn-success" data-dismiss="modal">Cancel</button>
                        </div>
                      </div>
                    </div>
                  </div>

                </td>
          </tr>
          <% }) %>


      </tbody>
    </table>



  </div>

  <script>
    $(document).ready(function () {

      let listOfServers = window.SAILS_LOCALS.ownedServers


      setInterval(function () {
        listOfServers.forEach(server => {
          sendRequestAndUpdateFps(server)
        })
      }, 300000)

      listOfServers.forEach(server => {
        $.ajax({
          url: `/api/sdtdticket/opentickets`,
          data: {
            serverId: server.id
          },
          success: (data, status, xhr) => {
            let opentickets = data;
            $(`#sdtd-server-${server.id}-tickets-badge`).text(opentickets.length)

          },
          error: (xhr, status, error) => {
            console.log(error)
          }
        });

        sendRequestAndUpdateFps(server)
        io.socket.get('/sdtdserver/' + server.id + '/socket', function (response) {
          sendRequestAndUpdatePlayers(server);
        });

        io.socket.on('playerConnected', (connectedMessage) => {
          sendRequestAndUpdatePlayers(server);
        })

        io.socket.on('playerDisconnected', (disconnectedMessage) => {
          sendRequestAndUpdatePlayers(server);
        })

      })
    })

    function sendRequestAndUpdateFps(server) {

      let serverId = server.id;
      $.get('/api/sdtdserver/fps', { serverId: serverId }, response => {
        $(`#server-${server.id}-fps`).text(`${response} FPS`)
      })

    }


    function sendRequestAndUpdatePlayers(server) {
      $.ajax({
        url: '/api/sdtdserver/players',
        data: {
          serverId: server.id
        },
        success: (data, status, xhr) => {
          let onlinePlayers = data.filter(player => {
            return player.online
          })
          $(`#server-${server.id}-players`).text(`${onlinePlayers.length} online`)
        },
        error: (xhr, status, error) => {
          console.log(`Could not update online players! error: ${error}`)
        }
      })
    }


  </script>