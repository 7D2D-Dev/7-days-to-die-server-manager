<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>hooks/sdtdLogs/index.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="ChatBridgeChannel.html">ChatBridgeChannel</a></li><li><a href="CustomDiscordEmbed.html">CustomDiscordEmbed</a></li><li><a href="Player.html">Player</a><ul class='methods'><li data-type='method'><a href="Player.html#.fn">fn</a></li><li data-type='method'><a href="Player.html#.getBanStatus">getBanStatus</a></li><li data-type='method'><a href="Player.html#.getInventory">getInventory</a></li><li data-type='method'><a href="Player.html#.getLocation">getLocation</a></li></ul></li><li><a href="SdtdServer.html">SdtdServer</a><ul class='methods'><li data-type='method'><a href="SdtdServer.html#.add-server">add-server</a></li><li data-type='method'><a href="SdtdServer.html#.console">console</a></li><li data-type='method'><a href="SdtdServer.html#.dashboard">dashboard</a></li><li data-type='method'><a href="SdtdServer.html#.delete">delete</a></li><li data-type='method'><a href="SdtdServer.html#.executeCommand">executeCommand</a></li><li data-type='method'><a href="SdtdServer.html#.get-players">get-players</a></li><li data-type='method'><a href="SdtdServer.html#.get-players-view">get-players-view</a></li><li data-type='method'><a href="SdtdServer.html#.load-server-info">load-server-info</a></li><li data-type='method'><a href="SdtdServer.html#.logging-toggle">logging-toggle</a></li><li data-type='method'><a href="SdtdServer.html#.sendMessage">sendMessage</a></li><li data-type='method'><a href="SdtdServer.html#.settings">settings</a></li><li data-type='method'><a href="SdtdServer.html#.subscribe-to-socket">subscribe-to-socket</a></li></ul></li><li><a href="User.html">User</a><ul class='methods'><li data-type='method'><a href="User.html#.ownedServers">ownedServers</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-7dtdLoggingHook.html">7dtdLoggingHook</a><ul class='methods'><li data-type='method'><a href="module-7dtdLoggingHook.html#.getLoggingObject">getLoggingObject</a></li><li data-type='method'><a href="module-7dtdLoggingHook.html#.getStatus">getStatus</a></li><li data-type='method'><a href="module-7dtdLoggingHook.html#.start">start</a></li><li data-type='method'><a href="module-7dtdLoggingHook.html#.stop">stop</a></li></ul></li><li><a href="module-AuthController.html">AuthController</a><ul class='methods'><li data-type='method'><a href="module-AuthController.html#.issueJWT">issueJWT</a></li><li data-type='method'><a href="module-AuthController.html#.logout">logout</a></li><li data-type='method'><a href="module-AuthController.html#.steamLogin">steamLogin</a></li><li data-type='method'><a href="module-AuthController.html#.steamReturn">steamReturn</a></li></ul></li><li><a href="module-DiscordBot.html">DiscordBot</a><ul class='methods'><li data-type='method'><a href="module-DiscordBot.html#.getClient">getClient</a></li><li data-type='method'><a href="module-DiscordBot.html#.initialize">initialize</a></li></ul></li><li><a href="module-DiscordCommands.html">DiscordCommands</a></li><li><a href="module-Helpers.html">Helpers</a><ul class='methods'><li data-type='method'><a href="module-Helpers.html#.Add7dtdServer">Add7dtdServer</a></li><li data-type='method'><a href="module-Helpers.html#.checkIfAvailable">checkIfAvailable</a></li><li data-type='method'><a href="module-Helpers.html#.createWebTokens">createWebTokens</a></li><li data-type='method'><a href="module-Helpers.html#.loadPlayerData">loadPlayerData</a></li><li data-type='method'><a href="module-Helpers.html#.loadSdtdServerInfo">loadSdtdServerInfo</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#discordId">discordId</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">hooks/sdtdLogs/index.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>var sevenDays = require('machinepack-7daystodiewebapi');

/**
 * @module 7dtdLoggingHook
 * @description Detects events on a 7dtd server.
 */
module.exports = function sdtdLogs(sails) {

  /**
   * @var {Map} loggingInfoMap Keeps track of servers with logging activated
   * @private
   */

  let loggingInfoMap = new Map();

  return {
    /**
     * @name initialize
     * @memberof module:7dtdLoggingHook
     * @description Called on app launch, loads all servers which have logging enabled and creates logging objects for these
     * @method
     * @private
     */
    initialize: function (cb) {
      sails.on('hook:orm:loaded', function () {
        sails.log.debug('HOOK: Initializing sdtdlogs');
        sails.models.sdtdserver.find({
          loggingEnabled: true
        }).exec(function (err, enabledServers) {
          if (err) {
            sails.log.error(`HOOKS - sdtdLogs - ${err}`);
          }

          _.each(enabledServers, async function (server) {
            try {
              let loggingObj = await createLogObject(server.id);
              return loggingInfoMap.set(String(server.id), loggingObj);
            } catch (error) {
              sails.log.error(`HOOKS - sdtdLogs - ${error}`);
            }

          });
        });
        return cb();
      });
    },

    /**
     * @name start
     * @memberof module:7dtdLoggingHook
     * @description Starts logging for a server
     * @param {number} serverID - Id of the server
     * @method
     */

    start: async function (serverID) {
      serverID = String(serverID)
      try {
        if (!loggingInfoMap.has(serverID)) {
          sails.log.debug(`HOOKS - sdtdLogs - starting logging for server ${serverID}`)
          await sails.models.sdtdserver.update({
            id: serverID
          }, {
            loggingEnabled: true
          })
          let loggingObj = await createLogObject(serverID);
          return loggingInfoMap.set(serverID, loggingObj);
        } else {
          throw new Error(`Tried to start logging for a server that already had it enables`)
        }

      } catch (error) {
        sails.log.error(`HOOKS - sdtdLogs - ${error}`);
      }
    },

    /**
     * @name stop
     * @memberof module:7dtdLoggingHook
     * @description Stops logging for a server
     * @param {number} serverID - Id of the server
     * @method
     */

    stop: async function (serverID) {

      try {
        if (loggingInfoMap.has(serverID)) {
          sails.log.debug(`HOOKS - sdtdLogs - stopping logging for server ${serverID}`)
          await sails.models.sdtdserver.update({
            id: serverID
          }, {
            loggingEnabled: false
          })
          let loggingObj = loggingInfoMap.get(serverID);
          loggingInfoMap.delete(serverID);
          return loggingObj.stop();
        }
      } catch (error) {
        sails.log.error(`HOOKS - sdtdLogs - ${error}`);
      }


    },

    /**
     * @name getLoggingObject
     * @memberof module:7dtdLoggingHook
     * @description Gets the logging object for a server
     * @param {number} serverId - Id of the server
     * @method
     */

    getLoggingObject: function (serverId) {
      let obj = loggingInfoMap.get(serverId);
      return obj
    },

    /**
     * @name getStatus
     * @memberof module:7dtdLoggingHook
     * @description Gets the logging status for a server
     * @param {number} serverId - Id of the server
     * @method
     */

    getStatus: function (serverId) {
      serverId = String(serverId)
      let status = loggingInfoMap.has(serverId);
      return status
    }
  };

  /**
   * @name createLoggingObject
   * @memberof module:7dtdLoggingHook
   * @description Creates a logging object for a 7dtd server
   * @param {number} serverID - Id of the server
   * @method
   * @private
   */

  function createLogObject(serverID) {
    return new Promise((resolve, reject) => {
      sails.models.sdtdserver.findOne({
        id: serverID
      }).exec(function (error, server) {
        if (error) {
          reject(error)
        }

        sevenDays.startLoggingEvents({
          ip: server.ip,
          port: server.webPort,
          authName: server.authName,
          authToken: server.authToken,
        }).exec({
          error: function (error) {
            reject(error)
          },
          success: function (eventEmitter) {
            eventEmitter.on('logLine', function (logLine) {
              sails.sockets.broadcast(server.id, 'logLine', logLine);
            });

            eventEmitter.on('chatMessage', function (chatMessage) {
              sails.sockets.broadcast(server.id, 'chatMessage', chatMessage);
            });

            eventEmitter.on('playerConnected', async function (connectedMsg) {
              try {
                await sails.helpers.loadPlayerData(server.id, connectedMsg.steamID);
                sails.sockets.broadcast(server.id, 'playerConnected', connectedMsg);
              } catch (error) {
                sails.sockets.broadcast(server.id, 'playerConnected', connectedMsg);
                sails.log.error(`HOOKS - sdtdLogs - ${error}`)
              }

            });

            eventEmitter.on('playerDisconnected', function (disconectedMsg) {
              sails.sockets.broadcast(server.id, 'playerDisconected', disconectedMsg);
            });

            eventEmitter.on('playerDeath', function (deathMessage) {
              sails.sockets.broadcast(server.id, 'playerDeath', deathMessage);
            });
            resolve(eventEmitter)
          }
        });
      });
    })


  }
};
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Thu Jan 18 2018 17:52:55 GMT+0100 (Romance Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
