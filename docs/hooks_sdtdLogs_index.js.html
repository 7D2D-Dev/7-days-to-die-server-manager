<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>hooks/sdtdLogs/index.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Player.html">Player</a></li><li><a href="SdtdServer.html">SdtdServer</a></li><li><a href="User.html">User</a></li></ul><h3>Modules</h3><ul><li><a href="module-7dtdLoggingHook.html">7dtdLoggingHook</a></li><li><a href="module-AuthController.html">AuthController</a><ul class='methods'><li data-type='method'><a href="module-AuthController.html#.logout">logout</a></li><li data-type='method'><a href="module-AuthController.html#.steamLogin">steamLogin</a></li><li data-type='method'><a href="module-AuthController.html#.steamReturn">steamReturn</a></li></ul></li><li><a href="module-Helpers.html">Helpers</a></li><li><a href="module-PlayerController.html">PlayerController</a><ul class='methods'><li data-type='method'><a href="module-PlayerController.html#~getBanStatus">getBanStatus</a></li><li data-type='method'><a href="module-PlayerController.html#~getInventory">getInventory</a></li><li data-type='method'><a href="module-PlayerController.html#~getLocation">getLocation</a></li><li data-type='method'><a href="module-PlayerController.html#~kick">kick</a></li></ul></li><li><a href="module-SdtdServerController.html">SdtdServerController</a><ul class='methods'><li data-type='method'><a href="module-SdtdServerController.html#.addServer">addServer</a></li><li data-type='method'><a href="module-SdtdServerController.html#.executeCommand">executeCommand</a></li><li data-type='method'><a href="module-SdtdServerController.html#.getPlayers">getPlayers</a></li><li data-type='method'><a href="module-SdtdServerController.html#.getServerInfo">getServerInfo</a></li><li data-type='method'><a href="module-SdtdServerController.html#.loadServerInfo">loadServerInfo</a></li><li data-type='method'><a href="module-SdtdServerController.html#.onlinePlayers">onlinePlayers</a></li><li data-type='method'><a href="module-SdtdServerController.html#.startLogging">startLogging</a></li><li data-type='method'><a href="module-SdtdServerController.html#.stopLogging">stopLogging</a></li><li data-type='method'><a href="module-SdtdServerController.html#.subscribeToServerSocket">subscribeToServerSocket</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">hooks/sdtdLogs/index.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>var sevenDays = require('machinepack-7daystodiewebapi');

 /**
  * @module 7dtdLoggingHook
  * @description Detects events on a 7dtd server.
  */
module.exports = function sdtdLogs(sails) {

    var loggingInfoMap = new Map();

    return {
        /**
         * @name initialize
         * @memberof module:7dtdLoggingHook
         * @description Called on app launch, loads all servers which have logging enabled and creates logging objects for these
         * @instance
         */
        initialize: function(cb) {
            sails.on('hook:orm:loaded', function() {
                sails.models.sdtdserver.find({ loggingEnabled: true }).exec(function(err, enabledServers) {
                    if (err) {
                        sails.log.error(new Error("Error getting logging enabled servers from DB"));
                        throw err;
                    }

                    _.each(enabledServers, function(server) {
                        createLogObject(server.id);
                    });
                });
                return cb();
            });
        },

        /**
         * @name start
         * @memberof module:7dtdLoggingHook
         * @description Starts logging for a server
         * @param {number} serverID - Id of the server
         * @instance
         */

        start: function(serverID) {

            if (!loggingInfoMap.has(parseInt(serverID))) {
                return sails.models.sdtdserver.update({ id: serverID }, { loggingEnabled: true })
                    .exec(function() {
                        return createLogObject(serverID);
                    });
            } else {
                let error = new Error("Tried to start logging for a server that already had it enabled");
                sails.log.error(error);
            }
        },

        /**
         * @name stop
         * @memberof module:7dtdLoggingHook
         * @description Stops logging for a server
         * @param {number} serverID - Id of the server
         * @instance
         */

        stop: function(serverID) {
            if (loggingInfoMap.has(serverID)) {
                return sails.models.sdtdserver.update({ id: serverID }, { loggingEnabled: false })
                    .exec(function() {
                        let loggingObj = loggingInfoMap.get(serverID);
                        loggingObj.stop();
                        loggingInfoMap.delete(serverID)
                    });
            }
        }
    };

        /**
         * @name createLoggingObject
         * @memberof module:7dtdLoggingHook
         * @description Creates a logging object for a 7dtd server
         * @param {number} serverID - Id of the server
         * @instance
         */

    function createLogObject(serverID) {
        sails.models.sdtdserver.findOne({ id: serverID }).exec(function(error, server) {
            if (error) {
                sails.log.error(new Error(`Error creating a logging object for ${server.id}`));
                throw error;
            }

            sevenDays.startLoggingEvents({
                ip: server.ip,
                port: server.webPort,
                authName: server.authName,
                authToken: server.authToken,
            }).exec({
                error: function(error) {
                    sails.log.error(new Error(`Error starting logs for ${server.id}`));
                    throw error;
                },
                success: function(eventEmitter) {
                    loggingInfoMap.set(server.id, eventEmitter);

                    eventEmitter.on('logLine', function(logLine) {
                        sails.sockets.broadcast(server.id, 'logLine', logLine);
                    });

                    eventEmitter.on('chatMessage', function(chatMessage) {
                        sails.sockets.broadcast(server.id, 'chatMessage', chatMessage);
                    });

                    eventEmitter.on('playerConnected', function(connectedMsg) {
                        sails.sockets.broadcast(server.id, 'playerConnected', connectedMsg);
                    });

                    eventEmitter.on('playerDisconected', function(disconectedMsg) {
                        sails.sockets.broadcast(server.id, 'playerDisconected', disconectedMsg);
                    });

                    eventEmitter.on('playerDeath', function(deathMessage) {
                        sails.sockets.broadcast(server.id, 'playerDeath', deathMessage);
                    });
                }
            });
        });

    }
}</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Tue Jan 02 2018 17:10:27 GMT+0100 (Romance Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
