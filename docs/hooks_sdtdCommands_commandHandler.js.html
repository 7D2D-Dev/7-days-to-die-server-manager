<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>hooks/sdtdCommands/commandHandler.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="ChatBridgeChannel.html">ChatBridgeChannel</a></li><li><a href="CustomDiscordEmbed.html">CustomDiscordEmbed</a></li><li><a href="Player.html">Player</a><ul class='methods'><li data-type='method'><a href="Player.html#.fn">fn</a></li><li data-type='method'><a href="Player.html#.fn">fn</a></li><li data-type='method'><a href="Player.html#.fn">fn</a></li><li data-type='method'><a href="Player.html#.fn">fn</a></li><li data-type='method'><a href="Player.html#.fn">fn</a></li><li data-type='method'><a href="Player.html#.getBanStatus">getBanStatus</a></li><li data-type='method'><a href="Player.html#.getInventory">getInventory</a></li><li data-type='method'><a href="Player.html#.getLocation">getLocation</a></li></ul></li><li><a href="SdtdServer.html">SdtdServer</a><ul class='methods'><li data-type='method'><a href="SdtdServer.html#.add-server">add-server</a></li><li data-type='method'><a href="SdtdServer.html#.available-items">available-items</a></li><li data-type='method'><a href="SdtdServer.html#.commands-reload">commands-reload</a></li><li data-type='method'><a href="SdtdServer.html#.commands-toggle">commands-toggle</a></li><li data-type='method'><a href="SdtdServer.html#.console">console</a></li><li data-type='method'><a href="SdtdServer.html#.country-ban-reload">country-ban-reload</a></li><li data-type='method'><a href="SdtdServer.html#.country-ban-toggle">country-ban-toggle</a></li><li data-type='method'><a href="SdtdServer.html#.dashboard">dashboard</a></li><li data-type='method'><a href="SdtdServer.html#.delete">delete</a></li><li data-type='method'><a href="SdtdServer.html#.executeCommand">executeCommand</a></li><li data-type='method'><a href="SdtdServer.html#.get-players">get-players</a></li><li data-type='method'><a href="SdtdServer.html#.get-players-view">get-players-view</a></li><li data-type='method'><a href="SdtdServer.html#.load-server-info">load-server-info</a></li><li data-type='method'><a href="SdtdServer.html#.logging-toggle">logging-toggle</a></li><li data-type='method'><a href="SdtdServer.html#.sendMessage">sendMessage</a></li><li data-type='method'><a href="SdtdServer.html#.server-infoview">server-infoview</a></li><li data-type='method'><a href="SdtdServer.html#.settings">settings</a></li><li data-type='method'><a href="SdtdServer.html#.subscribe-to-socket">subscribe-to-socket</a></li><li data-type='method'><a href="SdtdServer.html#.tickets-view">tickets-view</a></li><li data-type='method'><a href="SdtdServer.html#.update-connection-info">update-connection-info</a></li><li data-type='method'><a href="SdtdServer.html#.user-tickets-view">user-tickets-view</a></li></ul></li><li><a href="User.html">User</a></li></ul><h3>Modules</h3><ul><li><a href="module-7dtdCountryBan.html">7dtdCountryBan</a><ul class='methods'><li data-type='method'><a href="module-7dtdCountryBan.html#.getStatus">getStatus</a></li><li data-type='method'><a href="module-7dtdCountryBan.html#.reload">reload</a></li><li data-type='method'><a href="module-7dtdCountryBan.html#.start">start</a></li><li data-type='method'><a href="module-7dtdCountryBan.html#.stop">stop</a></li></ul></li><li><a href="module-7dtdLoggingHook.html">7dtdLoggingHook</a><ul class='methods'><li data-type='method'><a href="module-7dtdLoggingHook.html#.getLoggingObject">getLoggingObject</a></li><li data-type='method'><a href="module-7dtdLoggingHook.html#.getStatus">getStatus</a></li><li data-type='method'><a href="module-7dtdLoggingHook.html#.start">start</a></li><li data-type='method'><a href="module-7dtdLoggingHook.html#.stop">stop</a></li></ul></li><li><a href="module-AuthController.html">AuthController</a><ul class='methods'><li data-type='method'><a href="module-AuthController.html#.logout">logout</a></li><li data-type='method'><a href="module-AuthController.html#.steamLogin">steamLogin</a></li><li data-type='method'><a href="module-AuthController.html#.steamReturn">steamReturn</a></li></ul></li><li><a href="module-DiscordBot.html">DiscordBot</a><ul class='methods'><li data-type='method'><a href="module-DiscordBot.html#.getClient">getClient</a></li><li data-type='method'><a href="module-DiscordBot.html#.initialize">initialize</a></li></ul></li><li><a href="module-DiscordCommands.html">DiscordCommands</a></li><li><a href="module-Helpers.html">Helpers</a><ul class='methods'><li data-type='method'><a href="module-Helpers.html#.Add7dtdServer">Add7dtdServer</a></li><li data-type='method'><a href="module-Helpers.html#.checkIfAvailable">checkIfAvailable</a></li><li data-type='method'><a href="module-Helpers.html#.createTicket">createTicket</a></li><li data-type='method'><a href="module-Helpers.html#.createWebTokens">createWebTokens</a></li><li data-type='method'><a href="module-Helpers.html#.loadPlayerData">loadPlayerData</a></li><li data-type='method'><a href="module-Helpers.html#.loadSdtdServerInfo">loadSdtdServerInfo</a></li></ul></li><li><a href="module-SdtdCommands.html">SdtdCommands</a></li><li><a href="module-SdtdCommandsHook.html">SdtdCommandsHook</a><ul class='methods'><li data-type='method'><a href="module-SdtdCommandsHook.html#.getStatus">getStatus</a></li><li data-type='method'><a href="module-SdtdCommandsHook.html#.initialize">initialize</a></li><li data-type='method'><a href="module-SdtdCommandsHook.html#.start">start</a></li><li data-type='method'><a href="module-SdtdCommandsHook.html#.stop">stop</a></li><li data-type='method'><a href="module-SdtdCommandsHook.html#.updateConfig">updateConfig</a></li></ul></li><li><a href="module-SdtdConfig.html">SdtdConfig</a></li><li><a href="module-SdtdTicket.html">SdtdTicket</a></li></ul><h3>Global</h3><ul><li><a href="global.html#discordId">discordId</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">hooks/sdtdCommands/commandHandler.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>    /**
     * @memberof module:SdtdCommandsHook
     * @name commandHandler
     * @param {number} serverId
     * @param {loggingObject} loggingObject Obtained from the logging hook
     * @param {json} config Server commands config
     * @description Handles ingamecommands on a server
     */


    class CommandHandler {
      constructor(serverId, loggingObject, config) {
        this.serverId = serverId
        this.loggingObject = loggingObject
        this.config = config
        this.commands = CommandHandler.loadCommands.bind(this)()
        this.commandListener = CommandHandler.commandListener.bind(this)
        this.start()
      }
      /**
       * Start listening for commands
       */
      start() {
        this.commands = CommandHandler.loadCommands.bind(this)()
        let listenerFunction = this.commandListener
        this.loggingObject.on('chatMessage', listenerFunction);
      }

      /**
       * Stop listening for commands
       */

      stop() {
        let listenerFunction = this.commandListener
        this.loggingObject.removeListener('chatMessage', listenerFunction);
      }

      /**
       * Load enabled commands
       * @returns {Map}
       */

      static loadCommands() {

        let commands = new Map();
        let config = this.config

        const normalizedPath = require("path").join(__dirname, "commands");

        require("fs").readdirSync(normalizedPath).forEach(function (file) {
          let command = require("./commands/" + file);
          if (config.enabledCommands[command.name] === true) {
            commands.set(command.name.toLowerCase(), new command(config.server));
          }

        });

        return commands

      }

      /**
       * Attached to the logging event emitter
       * @param {json} chatMessage
       */

      static async commandListener(chatMessage) {

        try {
          if (chatMessage.messageText.startsWith(this.config.commandPrefix)) {
            let trimmedMsg = chatMessage.messageText.slice(this.config.commandPrefix.length, chatMessage.messageText.length)
            let splitString = trimmedMsg.split(' ')

            let commandName = splitString[0]
            let args = splitString.splice(1, splitString.length)

            if (this.commands.has(commandName)) {
              let player = await Player.find({name: chatMessage.playerName, server: this.config.server});
              player = player[0]

              let commandToRun = this.commands.get(commandName);

              return commandToRun.run(chatMessage, player.id, args)
            }
            sails.log.debug(`HOOK SdtdCommands:commandListener - Unknown command user by ${chatMessage.playerName} on server ${this.config.server}`)
          }
        } catch (error) {
          sails.log.error(`HOOK SdtdCommands:commandListener - ${error}`)
        }



      }
    }

    module.exports = CommandHandler
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Wed Jan 31 2018 15:22:40 GMT+0100 (Romance Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
