<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>hooks/discordBot/index.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="ChatBridgeChannel.html">ChatBridgeChannel</a></li><li><a href="CustomDiscordEmbed.html">CustomDiscordEmbed</a></li><li><a href="Player.html">Player</a><ul class='methods'><li data-type='method'><a href="Player.html#.getBanStatus">getBanStatus</a></li><li data-type='method'><a href="Player.html#.getInventory">getInventory</a></li><li data-type='method'><a href="Player.html#.getLocation">getLocation</a></li><li data-type='method'><a href="Player.html#.kick">kick</a></li></ul></li><li><a href="SdtdServer.html">SdtdServer</a><ul class='methods'><li data-type='method'><a href="SdtdServer.html#.fn">fn</a></li><li data-type='method'><a href="SdtdServer.html#.getPlayers">getPlayers</a></li><li data-type='method'><a href="SdtdServer.html#.getServerInfo">getServerInfo</a></li><li data-type='method'><a href="SdtdServer.html#.loadServerInfo">loadServerInfo</a></li><li data-type='method'><a href="SdtdServer.html#.onlinePlayers">onlinePlayers</a></li><li data-type='method'><a href="SdtdServer.html#.startLogging">startLogging</a></li><li data-type='method'><a href="SdtdServer.html#.stopLogging">stopLogging</a></li><li data-type='method'><a href="SdtdServer.html#.subscribeToServerSocket">subscribeToServerSocket</a></li></ul></li><li><a href="User.html">User</a><ul class='methods'><li data-type='method'><a href="User.html#.ownedServers">ownedServers</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-7dtdLoggingHook.html">7dtdLoggingHook</a><ul class='methods'><li data-type='method'><a href="module-7dtdLoggingHook.html#.getLoggingObject">getLoggingObject</a></li><li data-type='method'><a href="module-7dtdLoggingHook.html#.start">start</a></li><li data-type='method'><a href="module-7dtdLoggingHook.html#.stop">stop</a></li></ul></li><li><a href="module-AuthController.html">AuthController</a><ul class='methods'><li data-type='method'><a href="module-AuthController.html#.issueJWT">issueJWT</a></li><li data-type='method'><a href="module-AuthController.html#.logout">logout</a></li><li data-type='method'><a href="module-AuthController.html#.steamLogin">steamLogin</a></li><li data-type='method'><a href="module-AuthController.html#.steamReturn">steamReturn</a></li></ul></li><li><a href="module-DiscordBot.html">DiscordBot</a><ul class='methods'><li data-type='method'><a href="module-DiscordBot.html#.getClient">getClient</a></li><li data-type='method'><a href="module-DiscordBot.html#.initialize">initialize</a></li></ul></li><li><a href="module-DiscordCommands.html">DiscordCommands</a></li><li><a href="module-Helpers.html">Helpers</a><ul class='methods'><li data-type='method'><a href="module-Helpers.html#.Add7dtdServer">Add7dtdServer</a></li><li data-type='method'><a href="module-Helpers.html#.checkIfAvailable">checkIfAvailable</a></li><li data-type='method'><a href="module-Helpers.html#.createWebTokens">createWebTokens</a></li><li data-type='method'><a href="module-Helpers.html#.loadPlayerData">loadPlayerData</a></li><li data-type='method'><a href="module-Helpers.html#.loadSdtdServerInfo">loadSdtdServerInfo</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#discordId">discordId</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">hooks/discordBot/index.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const Commando = require('discord.js-commando');
const ChatBridgeChannel = require('./util/chatBridgeChannel.js');
const path = require('path');

/**
 * @module DiscordBot
 * @description a Sails project hook. Integrates a discord bot to the system
 * @param {*} sails Global sails instance
 */

/**
 * @module DiscordCommands
 * @description Command guide for users
 */

module.exports = function discordBot(sails) {

  return {

    /**
     * @memberof module:DiscordBot
     * @method
     * @name initialize
     * @description Starts the discord bot &amp; logs in
     */
    initialize: function (cb) {
      sails.on('hook:orm:loaded', function () {
        sails.on('hook:sdtdlogs:loaded', function () {
          sails.log.debug('HOOK: Initializing discord bot');

          client = new Commando.Client({
            owner: sails.config.custom.botOwners
          });

          sails.discordBotClient = client;

          // Register custom embed messages

          client.customEmbed = require('./util/createEmbed').CustomEmbed;
          client.errorEmbed = require('./util/createEmbed').ErrorEmbed;

          // Register some stuff in the registry... yeah..
          client.registry
            .registerGroups([
              ['7dtd', '7 Days to die']
            ])
            .registerDefaults()
            .registerCommandsIn(path.join(__dirname, 'commands'));

          // Listeners

          client.on('commandError', (command, error) => {
            sails.log.error(`Command error! ${command.memberName} trace: ${error.stack}`);
          });

          client.on('commandRun', (command, promise, message) => {
            sails.log.info(`Command ${command.name} ran by ${message.author.username}`);
          });

          // Login

          client.login(sails.config.custom.botToken).then(() => {
            sails.log.debug('Bot successfully logged in!');
            initChatBridges(client);
            return cb();
          })
            .catch((err) => {
              sails.log.error(err);
            });
        });
      });
    },

    /**
     * @memberof module:DiscordBot
     * @method
     * @name getClient
     * @description returns the discord client
     */

    getClient: function() {
      return sails.discordBotClient;
    }
  };

  async function initChatBridges(client) {
    // Find server that have chatbridge enabled
    let serversWithChatbridges = await SdtdServer.find({
      chatChannelId: {
        '!=': [0]
      }
    });

    // loop over enabled servers and create chatBridge class
    for (let index = 0; index &lt; serversWithChatbridges.length; index++) {
      const element = serversWithChatbridges[index];
      let discordguild = client.guilds.get(element.discordGuildId);
      let textChannel = client.channels.get(element.chatChannelId);
      if (!_.isUndefined(textChannel) &amp;&amp; !_.isUndefined(discordguild)) {
        discordguild.chatBridge = new ChatBridgeChannel(textChannel, element);
        discordguild.chatBridge.start();
      }
    }
  }
};
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Sat Jan 13 2018 18:54:36 GMT+0100 (Romance Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
